function EditCartDelivery(){deliveryAddressSelector.showPopup(3,2)}function RemoveCartDelivery(){var n=$("#hfCartType").val();$.ajax({url:"AjaxHandlers/DeliveryAjaxHandler.aspx",data:{a:"RemoveCartDelivery",cType:n},success:function(n,t){t=="success"&&(n.Success?(RecalculateCart(),LoadShoppingCart()):alert(n.Error))},error:HandleLoadError,dataType:"json",cache:!1})}function showOrderDeliveryPopup(n){deliveryAddressSelector.showPopup(1,2);_deliveryCartType=n;$(".modal.in").length==1}function LoadOrderDelivery(){_cartType="standard";$("#lnkClearDilivery").attr("onclick",'ConfirmClearOrder("'+_cartType+'")')}function removeOrder(n){var t=confirm("Are you sure you would like to remove this order?");t&&Delivery.DataService.removeDeliveryOrderItem(n).then(function(){$("#OrderNumber"+n).remove();alert("The order has been removed.")}).catch(function(n){alert(n)})}function ConfirmClearOrder(n){$("#ConfirmDeliveryClear").modal("show");$("#lnkConfirmDiliveryClear").attr("onclick",'ClearOrder("'+n+'")')}function ClearOrder(n){$.ajax({url:"AjaxHandlers/DeliveryAjaxHandler.aspx?a=ClearOder&cType="+n,success:function(){location.reload()},error:this.HandleLoadError,dataType:"json",cache:!1})}function HandleLoadError(n){$("#atcLoader").hide();alert(n.Error)}function stringReplace(n,t,i){while(t.match(n))t=t.replace(n,i);return t}var _deliveryCartType="",Delivery;$(document).ready(function(){$("#ddlAddressSelect").change(function(){var n=this.value;n=="New address"?($("#delDefaultField").show(),$("#delAddressName").show(),$(".delPriceAndALP").hide()):($("#delDefaultField").hide(),$("#delAddressName").hide(),$(".delPriceAndALP").show());$("#selectOptionToUse").hide();$("#delAddressButtons").show()})});Delivery={},function(n){var t=function(){"use strict";function t(n){var t="An error occured.";try{n.Error?t=n.Error:n.responseJSON&&n.responseJSON.Error?t=n.responseJSON.Error:n.TheData&&(t=n.TheData)}catch(i){}return t}var i="AjaxHandlers/DeliveryAjaxHandler.aspx",n=function(){};return n.getOrderDelivery=function(n,r){var u=$.ajax({url:i+"?a=GetWaybill",data:{orderNumber:n,includeTrackingEvents:r},method:"GET",dataType:"JSON"});return Promise.resolve(u).then(function(n){var t=n.TheData;return t.TrackingEvents=_.map(t.TrackingEvents,function(n){return n.Date=moment(n.Date).format("YYYY/MM/DD HH:mm"),n}),t}).catch(function(n){return Promise.reject(t(n))})},n.getDashboardDelivery=function(){var n=$.ajax({url:i+"?a=GetDashboardDelivery",method:"GET",dataType:"JSON"});return Promise.resolve(n).then(function(n){return n}).catch(function(n){return Promise.reject(t(n))})},n.removeDeliveryOrderItem=function(n,r){var u=$.ajax({url:i+"?a=RemoveDeliveryOrderItem",method:"POST",dataType:"JSON",data:{removeOrderNumber:n,quote:JSON.stringify(r)}});return Promise.resolve(u).then(function(n){return n.TheData.Address.DateCreated=moment(n.TheData.Address.DateCreated).format("YYYY/MM/DD"),n.TheData.Address.DateModified=moment(n.TheData.Address.DateModified).format("YYYY/MM/DD"),n.TheData.Address.DateLastModified=moment(n.TheData.Address.DateLastModified).format("YYYY/MM/DD"),n.TheData}).catch(function(n){return Promise.reject(t(n))})},n.recalculateDelivery=function(n){var r=$.ajax({url:i+"?a=RecalculateDelivery",method:"POST",dataType:"JSON",data:{cType:n}});return Promise.resolve(r).then(function(n){return n.TheData}).catch(function(n){return Promise.reject(t(n))})},n.updateShippingCost=function(n,i,r){var u=$.ajax({url:"AjaxHandler.aspx?a=UpdateShippingCost",method:"POST",dataType:"JSON",data:{cType:i,c:n,qn:r}});return Promise.resolve(u).then(function(n){return n.TheData}).catch(function(n){return Promise.reject(t(n))})},n.setDashboardDelivery=function(n,r){var u=$.ajax({url:i,data:{a:"SetDashboardQuoteService",service:JSON.stringify(n),address:JSON.stringify(r)},dataType:"json",cache:!1});return Promise.resolve(u).then(function(n){return n}).catch(function(n){return Promise.reject(t(n))})},n.getDeliveryServiceOptions=function(){var n=$.ajax({url:"AjaxHandlers/DeliveryAjaxHandler.aspx",data:{a:"GetDeliveryServiceOptions"},dataType:"json",cache:!1});return Promise.resolve(n).then(function(n){return n}).catch(function(n){return Promise.reject(t(n))})},n.addCartDelivery=function(n,i){var r=$.ajax({url:"AjaxHandlers/DeliveryAjaxHandler.aspx",data:{a:"AddCartDelivery",address:n,service:i},type:"POST",dataType:"json",cache:!1});return Promise.resolve(r).then(function(n){return n}).catch(function(n){return Promise.reject(t(n))})},n.updateCartDelivery=function(n,i,r){var u=$.ajax({url:"AjaxHandlers/DeliveryAjaxHandler.aspx",data:{a:"UpdateCartDelivery",address:JSON.stringify(n),service:JSON.stringify(i),cartType:r},type:"POST",dataType:"json",cache:!1});return Promise.resolve(u).then(function(n){return n}).catch(function(n){return Promise.reject(t(n))})},n.recalculateCart=function(n){var i=$.ajax({url:"AjaxHandler.aspx",data:{a:"RecalculateCart",cType:n},type:"GET",dataType:"json",cache:!1});return Promise.resolve(i).then(function(n){return n}).catch(function(n){return Promise.reject(t(n))})},n.getAddressBook=function(){var n=$.ajax({url:i,data:{a:"GetAddressBook"},dataType:"json",cache:!1});return Promise.resolve(n).then(function(n){return _.map(n.TheData,function(n){return n.DateCreated=moment(n.DateCreated).format("YYYY/MM/DD"),n.DateModified=moment(n.DateModified).format("YYYY/MM/DD"),n.DateLastModified=moment(n.DateLastModified).format("YYYY/MM/DD"),n})}).catch(function(n){return Promise.reject(t(n))})},n.addAddress=function(n){var i=$.ajax({url:"AjaxHandlers/DeliveryAjaxHandler.aspx",data:{a:"AddAddress",address:JSON.stringify(n)},type:"POST",dataType:"json",cache:!1});return Promise.resolve(i).then(function(n){return n.TheData}).catch(function(n){return Promise.reject(t(n))})},n.updateAddress=function(n,i){var r=$.ajax({url:"AjaxHandlers/DeliveryAjaxHandler.aspx",data:{a:"UpdateAddress",address:JSON.stringify(n),account:i},type:"POST",dataType:"json",cache:!1});return Promise.resolve(r).then(function(n){return n}).catch(function(n){return Promise.reject(t(n))})},n.deleteAddres=function(n){var i=$.ajax({url:"AjaxHandlers/DeliveryAjaxHandler.aspx",data:{a:"DeleteAddres",addressId:n},type:"POST",dataType:"json",cache:!1});return Promise.resolve(i).then(function(n){return n}).catch(function(n){return Promise.reject(t(n))})},n.getAutocompleteAddress=function(n){var r=$.ajax({url:i+"?a=getAutocompleteAddress&surbOrPostal="+n,method:"GET",dataType:"JSON",data:{addressCode:n}});return Promise.resolve(r).then(function(n){return n}).catch(function(n){return Promise.reject(t(n))})},n.getClientDefaultAddress=function(n){var r=$.ajax({url:i+"?a=GetAddressBook",method:"GET",dataType:"JSON",data:{accountNo:n}});return Promise.resolve(r).then(function(n){return n}).catch(function(n){return Promise.reject(t(n))})},n.getClientALPPoints=function(n,r){var u=$.ajax({url:i,method:"GET",dataType:"JSON",data:{a:"GetALPData",aid:n,cartType:r}});return Promise.resolve(u).then(function(n){return n}).catch(function(n){return Promise.reject(t(n))})},n.placeDeliveryOrder=function(n,r,u,f,e,o,s){var h=$.ajax({url:i,method:"GET",dataType:"JSON",data:{a:"PlaceDeliveryOrder",orders:JSON.stringify(u),quoteNumber:n,service:r,referenceNumber:f,name:e,phoneNumber:o,email:s}});return Promise.resolve(h).then(function(n){return n}).catch(function(n){return Promise.reject(t(n))})},n.cancelDeliveryOrder=function(n){var r=$.ajax({url:i,method:"GET",dataType:"JSON",data:{a:"CancelDelivery",deliveryNumber:n}});return Promise.resolve(r).then(function(n){return n}).catch(function(n){return Promise.reject(t(n))})},n}();n.DataService=t}(Delivery);var GlobaladdressBook=[],globalAddressId,deliveryAddressSelector=function(){"use strict";function w(){e=$("#delAddressButtons");l=$("#selectOptionToUse");a=$(".delPriALP");r=$("#delAddressName");s=$("#delDefaultField")}function g(){var n=$("#ddlAddressSelect option:selected").text();i==f.manageAddresses?(s.show(),$("#ManageDeliveryHeading").show(),$("#btnManageAddress").show(),e.hide(),$(".delPriceAndALP").hide(),$("#divOrderDelivery").hide(),$("#spWordSelection").html("Select Address"),$("#txtDeliveryAddressName").show(),r.show(),n=="Add New address"?($("#chkEndUserDelivery").prop("checked",!0),$("#btnDelete").hide()):$("#btnDelete").show()):(n=="Add New address"?($("#chkEndUserDelivery").prop("checked",!0),r.show(),s.show(),$("#txtDeliveryAddressName").show()):(r.hide(),$("#txtDeliveryAddressName").hide(),$(".addressAccordion").show(),$(".addressPanel").hide(),s.hide()),$("#OrderDeliveryHeading").show(),e.show(),$("#divOrderDelivery").show(),$("#ManageDeliveryHeading").hide(),$("#btnManageAddress").hide(),$("#spWordSelection").html("To"))}function c(){$("#loadAddressData").show()}function t(){$("#loadAddressData").hide()}function nt(n,r,s){u=r;i=n;c();u=r;i=n;v=null;$(".addressAccordion").hide();$(".addressPanel").show();$("#orderDelivery").modal("show");et().then(function(){var r,n,a,c;GlobaladdressBook.length?(r=_.find(GlobaladdressBook,function(n){return n.IsDefault==!0}),r||(GlobaladdressBook=_.orderBy(GlobaladdressBook,["AddressName"],["asc"]),r=GlobaladdressBook[0]),y(r.AddressName)):($("#btnSaveUpdate").html("Save"),$("#btnDelete").hide(),n=$("#defaultAddress"),n.empty(),n.append($("<option><\/option>").val("No").text("No")),n.append($("<option><\/option>").val("Yes").text("Yes")),n.trigger("chosen:updated"));p();it();w();l.hide();e.show();h=s;g();u==o.dashboard||u==o.orderDeliveryPage?(a=JSON.parse(localStorage.getItem("deliveryQuote")),h||(h=[]),$(".delPriceAndALP").hide()):i!=f.manageAddresses&&(c=$("#ddlAddressSelect option:selected").text(),c=="Add New address"&&$(".delPriceAndALP").hide());t();$("#txtSuburbCode,#txtDeliveryPostalCode").attr("autocomplete","new-password")}).catch(function(n){t();alertMessage(n)});$("#txtSuburbCode,#txtDeliveryPostalCode").attr("autocomplete","new-password")}function tt(){var y=!1,w=!1,s,p;e.hide();i!=f.manageAddresses?c():a.hide();s=$("#ddlAddressSelect option:selected").text();s=="Add New address"?(y=!0,s=$("#txtDeliveryAddressName").val(),w=!0,r.show()):(r.hide(),$(".addressAccordion").show(),$(".addressPanel").hide());p=null;p=y?d():Promise.resolve();p.then(function(){var e=$("#txtHiddedAddressID").val(),r=$("#hfCartType").val();$.ajax({url:"AjaxHandlers/DeliveryAjaxHandler.aspx",data:{a:"GetDeliveryServiceOptions",aid:e,orders:JSON.stringify(h),cartType:r},success:function(e,p){p=="success"&&(e.Success?(l.show(),a.show(),v=e.TheData.QuoteDetails,t(),$("tbody","#deliveryOptionsTable").html(e.TheData.RowsHTML),$("tbody tr","#deliveryOptionsTable").click(function(){var e,a,p,w,l,k;c();e={quoteNumber:$(this).attr("qn"),service:$(".delService",this).html(),eta:$(".delETA",this).html(),totalCost:$(".delTotalCost span",this).html().replace("&nbsp;",""),fromAddress:"Amrod JHB",addressName:s,addressId:$(this).attr("aid")};a=u==o.dashboard?"OrderDelivery":null;a==null&&r=="logo24"&&(a=r);p=null;y&&(p={CompanyName:$("#txtDeliveryCompanyName").val(),ContactName:$("#txtDeliveryContactName").val(),Address1:$("#txtDeliveryAddress1").val(),Suburb:$("#txtSuburbCode").val(),City:$("#txtDeliveryCity").val(),StateProvince:$("#txtDeliveryProvince").val(),PostalCode:$("#txtDeliveryPostalCode").val(),AddressName:$("#txtDeliveryAddressName").val(),IsDefault:$("#defaultAddress option:selected").text(),ContactNumber:$("#txtContactNumber").val(),OfficePark:$("#txtOfficePark").val(),Country:$("#txtCountry").val()});i==f.editDelivery&&u==o.cart?Delivery.DataService.updateCartDelivery(p,e,a).then(function(){alertMessage("The cart has been updated with the selected delivery option.");$("#otherMessageDialog").is(":visible")&&$("#btnMainAlertOk").click(function(){u==o.cart&&b()})}).catch(function(n){alertMessage(n);t()}):u==o.dashboard||u==o.orderDeliveryPage?(w=e.service.includes("Priority")?"Overnight":e.service,l=_.find(v,function(n){return n.Service==w}),l==null&&(l=_.find(v,function(n){return e.service.includes(n.Service)})),k={quoteNumber:e.quoteNumber,courier:l.Courier,service:l.Service,price:l.Price,ETATotalDays:l.EstDeliveryDate,fromAddress:e.fromAddress,orders:h,address:n},localStorage.setItem("deliveryQuote",JSON.stringify(k)),window.location="OrderDelivery.aspx"):$.ajax({url:"AjaxHandlers/DeliveryAjaxHandler.aspx",data:{a:"AddCartDelivery",address:JSON.stringify(s),service:JSON.stringify(e),cType:a},type:"POST",success:function(n,t){t=="success"?n.Success?b():alertMessage(n.Error):alertMessage(n.Error)},error:HandleLoadError,dataType:"json",cache:!1})})):(alertMessage(e.Error),t(),l.hide(),a.hide()))},error:HandleLoadError,dataType:"json",cache:!1})}).catch(function(n){t();alertMessage(n)})}function b(){var n=$("#hfCartType").val();Delivery.DataService.recalculateCart(n).then(function(){window.location="ViewCart.aspx?t="+n}).catch(function(n){t();alert(n)})}function it(){$("#txtSuburbCode").autocomplete({source:function(n,t){Delivery.DataService.getAutocompleteAddress(n.term).then(function(n){var i=n.TheData,r;i.length>0?(r=$.map(i,function(n){return{label:n.Suburb+" - "+n.PostalCode,value:n.Suburb,obj:n}}),t(r)):t([{label:"No results found.",val:-1}])})},minLength:3,select:function(n,t){$("#txtDeliveryPostalCode").val(t.item.obj.PostalCode);$("#txtDeliveryProvince").val(t.item.obj.Province);$("#txtDeliveryCity").val(t.item.obj.City)},focus:function(){$("#txtSuburbCode").attr("autocomplete","new-password")}});$("#txtDeliveryPostalCode").autocomplete({source:function(n,t){Delivery.DataService.getAutocompleteAddress(n.term).then(function(n){var i=n.TheData,r;i.length>0?(r=$.map(i,function(n){return{label:n.Suburb+" - "+n.PostalCode,value:n.PostalCode,obj:n}}),t(r)):t([{label:"No results found.",val:-1}])})},minLength:3,select:function(n,t){$("#txtSuburbCode").val(t.item.obj.Suburb);$("#txtDeliveryProvince").val(t.item.obj.Province);$("#txtDeliveryCity").val(t.item.obj.City)}})}function rt(){var p=$("#txtDeliveryCompanyName").val(),w=$("#txtDeliveryContactName").val(),t=$("#txtContactNumber").val(),b=$("#txtDeliveryAddress1").val(),r=$("#txtSuburbCode").val().trim(),o=$("#txtDeliveryCity").val(),s=$("#txtDeliveryProvince").val(),e=$("#txtDeliveryPostalCode").val(),k=$("#txtCountry").val(),nt=$("#txtOfficePark").val(),it=$("#ddlAddressSelect option:selected").text(),g,h=!1,c=!1,l=!0,n=!0,a,v;k==""&&(n=!1);b==""&&(n=!1);r==""&&(n=!1);o==""&&(n=!1);s==""&&(n=!1);(e==""||e.length<=3)&&($("#txtDeliveryPostalCode").css("border-color","#843534"),$("#divDeliveryPostalCode").attr("class","form-group has-error"),n=!1);w==""&&(n=!1);t==""&&(n=!1);p==""&&(n=!1);a=/^((\+[1-9]{1,4}[ \-]*)|(\([0-9]{2,3}\)[ \-]*)|([0-9]{2,4})[ \-]*)*?[0-9]{3,4}?[ \-]*[0-9]{3,4}?$/;a.test(t)||(t!=""?($("#txtContactNumber").css("border-color","#843534"),$("#divContactNumber").attr("class","form-group has-error")):t==""&&($("#txtContactNumber").css("border-color","#843534"),$("#divContactNumber").attr("class","form-group has-error")),n=!1);v=t.replace(/\D/g,"");v.length<9&&($("#txtContactNumber").css("border-color","#843534"),$("#divContactNumber").attr("class","form-group has-error"),n=!1);$(".FormcontentLoader").fadeIn();var u="",y="";g=Delivery.DataService.getAutocompleteAddress(e).then(function(n){let t=n.TheData;t.length>0&&_.forEach(t,function(n){if(n.PostalCode==e&&n.Suburb.toLowerCase()==r.toLowerCase().trim())return c=!0,y=n.Province.toLowerCase(),u=n.City.toLowerCase(),!1})}).then(function(){var t=r.toLowerCase().trim();Delivery.DataService.getAutocompleteAddress(t).then(function(n){$(".FormcontentLoader").fadeOut();let i=n.TheData;i.length>0&&_.forEach(i,function(n){if(n.Suburb.toLowerCase()==t&&n.City.toLowerCase()==u)return h=!0,u=n.City.toLowerCase(),!1})}).then(function(){o.toLowerCase()==r.toLowerCase()&&u.toLowerCase()!=r.toLowerCase()&&(l=!1,n=!1,$("#txtSuburbCode").css("border-color","#843534"),$("#divSuburbCode").attr("class","form-group has-error"),$("#txtDeliveryCity").css("border-color","#843534"),$("#divCity").attr("class","form-group has-error"));y!==s.toLowerCase().trim()&&(n=!1,$("#txtDeliveryProvince").css("border-color","#843534"),$("#divDeliveryProvince").attr("class","form-group has-error"));u.toLowerCase()!==o.toLowerCase().trim()&&(n=!1,$("#txtDeliveryCity").css("border-color","#843534"),$("#divCity").attr("class","form-group has-error"));c||(n=!1,$("#txtDeliveryPostalCode").css("border-color","#843534"),$("#divDeliveryPostalCode").attr("class","form-group has-error"));h?($("#txtSuburbCode").css("border-color","#3c763d;"),$("#divSuburbCode").attr("class","form-group has-success")):(n=!1,$("#txtSuburbCode").css("border-color","#843534"),$("#divSuburbCode").attr("class","form-group has-error"));n?($(".in#orderDelivery .modal-body input.form-control").css("border-color","#ddd"),$("label[class=control-label]").css({color:"#7d7d7d"}),$("#addressForm").data("bootstrapValidator").resetForm(),i==f.manageAddresses?(d(),$(".FormcontentLoader").fadeOut()):(tt(),$(".FormcontentLoader").fadeOut())):($(".FormcontentLoader").fadeOut(),l?alertMessage("Please confirm that all of the required fields have valid values for an existing address."):alertMessage("Suburb and city fields have been duplicated."))})}).catch(function(n){$(".FormcontentLoader").fadeOut();alertMessage(n)})}function ut(){var n=$("#txtDeliveryPostalCode").val(),t=!1,i=Delivery.DataService.getAutocompleteAddress(n).then(function(i){var r=i.TheData;r.length>0&&_.forEach(r,function(i){if(i.PostalCode==n)return t=!0,!1});$(".FormcontentLoader").fadeOut()}).catch(function(n){$(".FormcontentLoader").fadeOut();alertMessage(n)});i.then(function(){t||($("#txtDeliveryPostalCode").css("border-color","#843534"),$("#divDeliveryPostalCode").attr("class","form-group has-error"),alertMessage("Please confirm that all of the required fields have valid values for an existing address."))})}function y(t){var r,u,e,o;n=_.find(GlobaladdressBook,function(n){return n.AddressName==t});r=!1;(i==f.addDelivery||i==f.editDelivery)&&(r=!0);$("#txtDeliveryCompanyName").val(n.CompanyName).prop("disabled",r).css("background-color","#fff");$("#txtDeliveryContactName").val(n.ContactName).prop("disabled",r).css("background-color","#fff");$("#txtContactNumber").val(n.ContactNumber).prop("disabled",r).css("background-color","#fff");$("#txtDeliveryAddress1").val(n.StreetLine1).prop("disabled",r).css("background-color","#fff");$("#txtSuburbCode").val(n.Suburb).prop("disabled",r).css("background-color","#fff");$("#txtDeliveryCity").val(n.City).prop("disabled",r).css("background-color","#fff");$("#txtDeliveryProvince").val(n.Province).prop("disabled",r).css("background-color","#fff");$("#txtDeliveryPostalCode").val(n.PostalCode).prop("disabled",r).css("background-color","#fff");$("#txtDeliveryAddressName").val(n.AddressName).prop("disabled",r).css("background-color","#fff");$("#txtOfficePark").val(n.OfficePark).prop("disabled",r).css("background-color","#fff");$("#txtCountry").val(n.Country).prop("disabled",!0).css("background-color","#fff");$("#txtHiddedAddressID").val(n.Id);n.IsEndUserAddress?$("#chkEndUserDelivery").prop("checked",!0):$("#chkEndUserDelivery").prop("checked",!1);u="No";e="No";$("#defaultAddress").empty();n.IsDefault?u="Yes":e="Yes";o=$("#defaultAddress");o.append($("<option><\/option>").val(u).text(u));o.append($("<option><\/option>").val(e).text(e));o.trigger("chosen:updated")}function ft(n,t){var i=n.AddressName.toLowerCase(),r=t.AddressName.toLowerCase();return i<r?-1:i>r?1:0}function p(){var n=$("#ddlAddressSelect"),i,r,t;GlobaladdressBook!=null&&GlobaladdressBook.length>0&&(r=_.find(GlobaladdressBook,function(n){return n.IsDefault==!0}),i=r?_.orderBy(GlobaladdressBook,["IsDefault"],["desc"]):GlobaladdressBook,t=_.map(i,function(n){return n.AddressName!=null?n.AddressName:n.StreetLine1}),n.empty(),t=_.uniq(t),t.forEach(function(t){n.append($("<option><\/option>").val(t).text(t))}));GlobaladdressBook==null||GlobaladdressBook.length==0?(n.empty(),$(".chosen-single").css("font-weight","Bold"),n.append($("<option><\/option>").val("Add New address").text("Add New address")),n.trigger("chosen:updated")):($(".chosen-single").css("font-weight","Bold"),$("<option value='New address'>Add New address<\/option>").css("font-weight","Bold").insertAfter($("#ddlAddressSelect option:first")),n.trigger("chosen:updated"))}function et(){return Promise.resolve().then(function(){return GlobaladdressBook!=null&&GlobaladdressBook.length>0?GlobaladdressBook.sort(ft):Delivery.DataService.getAddressBook().then(function(n){var t,i;if(n)for(i=0;i<n.length;i++)t=n[i],(t.AddressName===undefined||t.AddressName===null)&&(t.AddressName=t.StreetLine1),GlobaladdressBook[i]=t;return n}).catch(function(n){return Promise.reject(n)})})}function ot(){var t,n;w();$("#addressForm").data("bootstrapValidator").resetForm();t=$("#ddlAddressSelect option:selected").text();t!="Add New address"?($(".in#orderDelivery .modal-body input.form-control").css("border-color","#ddd"),s.hide(),y(t),$("#btnDelete").show(),$("#btnSaveUpdate").html("Update")):($("#btnSaveUpdate").html("Save Address"),$("#btnDelete").hide(),k(),$(".delPriceAndALP").hide(),$("#chkEndUserDelivery").prop("checked",!0),n=$("#defaultAddress"),n.empty(),n.append($("<option><\/option>").val("No").text("No")),n.append($("<option><\/option>").val("Yes").text("Yes")),n.trigger("chosen:updated"));i==f.manageAddresses?(s.show(),$("#ManageDeliveryHeading").show(),$("#btnManageAddress").show(),e.hide(),$(".delPriceAndALP").hide(),$("#divOrderDelivery").hide(),$("#spWordSelection").html("Select Address"),$("#txtDeliveryAddressName").show(),r.show()):(t=="Add New address"?($(".addressAccordion").hide(),$(".addressPanel").show(),$(".addressAccordion").html("Hide Details"),$("#txtDeliveryAddressName").show(),r.show()):($(".addressAccordion").show(),$(".addressAccordion").html("View Details"),$(".addressPanel").hide(),r.hide(),$("#txtDeliveryAddressName").hide()),$("#OrderDeliveryHeading").show(),e.show(),$("#divOrderDelivery").show(),$("#ManageDeliveryHeading").hide(),$("#btnManageAddress").hide(),$("#spWordSelection").html("To"))}function k(){$("#orderDelivery input[class='form-control']").each(function(){$(this).val("");$("#txtDeliveryAddress1").prop("disabled",!1);$("#txtDeliveryCompanyName").prop("disabled",!1);$("#txtDeliveryContactName").prop("disabled",!1);$("#txtContactNumber").prop("disabled",!1);$("#txtCountry").prop("disabled",!1);$("#txtDeliveryAddress1").prop("disabled",!1);$("#txtOfficePark").prop("disabled",!1);$("#txtSuburbCode").prop("disabled",!1);$("#txtDeliveryCity").prop("disabled",!1);$("#txtDeliveryProvince").prop("disabled",!1);$("#txtDeliveryPostalCode").prop("disabled",!1);$("#txtDeliveryAddressName").prop("disabled",!1);$("input#txtDeliveryPostalCode").val("");$("input#txtDeliveryCompanyName").val("");$("input#txtDeliveryAddress1").val("");$("input#txtOfficePark").val("");$("input#txtSuburbCode").val("")});$("label[class=control-label]").css({color:"#7d7d7d"});$("input:checkbox").removeAttr("checked");$("#txtCountry").val("South Africa").prop("disabled",!0).css("background-color","#fff")}function d(){var e,u,f,n,r,h,l;if(c(),u=$("#ddlAddressSelect option:selected").text(),f=!1,$("#defaultAddress option:selected").text()=="Yes"){for(r=0;r<GlobaladdressBook.length;r++)n=GlobaladdressBook[r],n.IsDefault===!0&&(n.IsDefault=!1),n.AddressName==u&&n.AddressName!=$("#txtDeliveryAddressName").val()&&(n.AddressName=$("#txtDeliveryAddressName").val()),GlobaladdressBook[r]=n;f=!0}var o=$("#chkEndUserDelivery").is(":checked"),i={CompanyName:$("#txtDeliveryCompanyName").val(),ContactName:$("#txtDeliveryContactName").val(),ContactNumber:$("#txtContactNumber").val(),StreetLine1:$("#txtDeliveryAddress1").val(),OfficePark:$("#txtOfficePark").val(),Suburb:$("#txtSuburbCode").val(),City:$("#txtDeliveryCity").val(),Province:$("#txtDeliveryProvince").val(),Country:$("#txtCountry").val(),PostalCode:$("#txtDeliveryPostalCode").val(),AddressName:$("#txtDeliveryAddressName").val(),Id:$("#txtHiddedAddressID").val(),IsDefault:f,IsEndUserAddress:o},s="testAccount";return u=="Add New address"?(h={CompanyName:$("#txtDeliveryCompanyName").val(),ContactName:$("#txtDeliveryContactName").val(),ContactNumber:$("#txtContactNumber").val(),StreetLine1:$("#txtDeliveryAddress1").val(),OfficePark:$("#txtOfficePark").val(),Suburb:$("#txtSuburbCode").val(),City:$("#txtDeliveryCity").val(),Province:$("#txtDeliveryProvince").val(),Country:$("#txtCountry").val(),PostalCode:$("#txtDeliveryPostalCode").val(),AddressName:$("#txtDeliveryAddressName").val(),IsDefault:f,IsEndUserAddress:o},e=Delivery.DataService.addAddress(h,s).then(function(n){return alertMessage("The address has been added."),t(),n}).catch(function(n){t();alertMessage(n)})):(e=Delivery.DataService.updateAddress(i,s).then(function(){alertMessage("The address has been updated.");t()}).catch(function(n){t();alertMessage(n)}),l=$("#txtHiddedAddressID").val(),GlobaladdressBook=_.reject(GlobaladdressBook,function(n){return n.Id===parseInt(l)})),e.then(function(n){n&&u=="Add New address"&&(i.Id=n.Id,i.ContactName=n.ContactName,i.ContactNumber=n.ContactNumber,$("#txtHiddedAddressID").val(n.Id),globalAddressId=n.Id);GlobaladdressBook=jQuery.grep(GlobaladdressBook,function(n){return n.Id!=i.Id});GlobaladdressBook.push(i);var t=$("#txtDeliveryAddressName").val();p();y(t);$("#ddlAddressSelect option").each(function(){$(this).attr("value")==$("#txtDeliveryAddressName").val()&&($(this).attr("selected",!0),$("#ddlAddressSelect").val($(this).attr("value")),$("#ddlAddressSelect").trigger("chosen:updated"))})})}function st(){$(".confirmD").fadeIn("slow")}function ht(){$(".confirmD").fadeOut("slow")}function ct(){var i,n;$(".confirmD").fadeOut("slow");i=$("#txtHiddedAddressID").val();c();Delivery.DataService.deleteAddres(i).then(function(){alertMessage("The address has been Deleted.");t()}).catch(function(n){alertMessage(n)});GlobaladdressBook=_.reject(GlobaladdressBook,function(n){return n.Id===parseInt(i)});GlobaladdressBook.length?(n=_.find(GlobaladdressBook,function(n){return n.IsDefault==!0}),p(),n||(n=GlobaladdressBook[0]),y(n.AddressName)):GlobaladdressBook.length==0&&(k(),$("#ddlAddressSelect").empty(),$("#ddlAddressSelect").append($("<option><\/option>").val("Add New address").text("Add New address")),$("#ddlAddressSelect").trigger("chosen:updated"),$("#btnDelete").hide(),$("#btnSaveUpdate").html("Save"));$("#addressForm").data("bootstrapValidator").resetForm()}function lt(){$(".addressAccordion").html("View Details");$("#addressForm").data("bootstrapValidator").resetForm()}function at(){var n=$(".addressAccordion").text();n=="View Details"?($(".addressAccordion").html("Hide Details"),$(".addressPanel").show()):($(".addressAccordion").html("View Details"),$(".addressPanel").hide())}var e,l,a,r,s,i,u,h,n,v,vt=localStorage;GlobaladdressBook=[];var f={addDelivery:1,manageAddresses:2,editDelivery:3},o={base:1,cart:2,dashboard:3,orderDeliveryPage:4};return{showPopup:nt,checkAddressSelection:ot,ValidateInputs:rt,deleteAddress:ct,ConfirmDeleteAddress:st,DismissDeletePopup:ht,closePopup:lt,addressAccordionToggle:at,ValidateOnblur:ut}}(),editDeliveryService=function(){"use strict";function tt(){t=$("#orderDeliveryModal");f=t.find(".modal-body")}function it(){i=$("#trackingEventsBody");y=$("#trackingEventRowTemplate");e=$("#trackingEventsSection");r=$("#podSection");p=$("#btnViewPOD");w=$("#addressSuburbSection");b=$("#addressCitySection");nt=$("#estDeliverySection");o=$("#boxCountSection");u=$("#signatureSection");s=$("#signedBySection");h=$("#timestampSection");k=$("#otherOrderNumbers");d=$("#otherOrdersSection");g=$("#courierNameSection");c=$("#EditDeliveryControls");l=$("#amrodCallCentreSection");a=$("#courierCallCentreSection")}function rt(y){tt();showPageLoading();Delivery.DataService.getOrderDelivery(y).then(function(nt){var ot,tt;hidePageLoading();f.empty();var rt=nt.Address,ft="",ut=nt.DeliveryCourierDetailsVO,et=!1;typeof ut!="undefined"&&ut!==null&&ut.ContactNumber!==null&&(et=!0,ft=ut.ContactNumber);ot={orderNumber:y,quoteNumber:nt.QuoteNumber,courier:nt.Courier,service:nt.Service,price:nt.QuotePrice,ETATotalDays:nt.ETATotalDays,fromAddress:"Amrod JHB",orders:_.map(nt.DeliveryWaybillDetails,function(n){return{orderNumber:n.DocumentNumber,poNumber:n.DocumentCustomerReference,statusText:n.DocumentStatusDisplay}}),address:nt.Address};n=ot;f.loadTemplate($("#orderDeliveryTemplate"),{from:nt.FromAddress||"Amrod JHB",addressLine1:rt.StreetLine1,addressLine2:rt.StreetLine2,suburb:rt.Suburb,city:rt.City,postalCode:rt.PostalCode,courier:nt.Courier,service:nt.Service,status:nt.StatusDisplay,ETA:nt.QuoteLeadTime==null?"":"("+nt.QuoteLeadTime+")",totalAmount:nt.TotalExclAmount.toFixed(2),numOrders:nt.DeliveryWaybillDetails.length,waybillNumber:nt.Number,orderNumber:nt.OrderNumber,boxCount:nt.boxCount,signature:nt.Signature,signedBy:nt.SignedBy,timestamp:nt.Timestamp,courierCallCentre:ft,amrodCallCentre:nt.AmrodCallCenterNumber});it();e.hide();i.empty();r.hide();rt.City||b.hide();rt.Suburb||w.hide();et?(l.hide(),a.show()):(l.show(),a.hide());(nt.Flags&v.Booked)!=0?c.hide():c.show();nt.Courier||g.hide();(nt.Flags&v.DeliveredFromProvider)>0?(r.show(),p.attr("onclick","DashboardOrderModuleController.DownloadDocument('POD', '"+y+"', null)"),u.hide()):(r.hide(),o.hide(),u.hide(),s.hide(),h.hide());nt.DeliveryWaybillDetails.length>0?(tt="",nt.DeliveryWaybillDetails.forEach(function(n,t){tt=tt+n.DocumentNumber;t<nt.DeliveryWaybillDetails.length-1&&(tt=t<nt.DeliveryWaybillDetails.length-1?tt+" and ":tt+", ")}),k.html(tt)):d.hide();t.modal("show")}).catch(function(n){hidePageLoading();n.message==="An error occurred"?alertMessage("The delivery information could not be retrieved"):alertMessage(n)})}function ut(){showPageLoading();Delivery.DataService.getOrderDelivery(n.orderNumber,!0).then(function(n){hidePageLoading();i.empty();n.TrackingEvents&&n.TrackingEvents.length>0?(n.TrackingEvents.forEach(function(n){i.loadTemplate(y,{date:n.Date,event:n.Description},{append:!0})}),e.show()):alertMessage("This order has no tracking events.");(n.Flags&v.DeliveredFromProvider)>0&&($("span","#"+o.attr("id")).html(n.BoxCount),$("span","#"+u.attr("id")).html(n.Signature),$("span","#"+s.attr("id")).html(n.SignedBy),$("span","#"+h.attr("id")).html(moment(n.Timestamp).format("YYYY/MM/DD HH:mm")))}).catch(function(n){hidePageLoading();alertMessage(n)})}function ft(){showPageLoading();localStorage.setItem("deliveryQuote",JSON.stringify(n));localStorage.setItem("existingDeliveryQuote",JSON.stringify(n));window.location="OrderDelivery.aspx"}function et(){return $(".confirmD").fadeOut("slow"),showPageLoading(),Delivery.DataService.cancelDeliveryOrder(n.orderNumber).then(function(){hidePageLoading();t.modal("hide");alertMessage("The delivery has been cancelled.")}).catch(function(n){hidePageLoading();alertMessage(n)})}function ot(){$(".confirmCancelDelivery").fadeIn("slow")}function st(){$(".confirmCancelDelivery").fadeOut("slow")}var n=null,t=null,f=null,e=null,i=null,y=null,r=null,p=null,w=null,b=null,nt=null,o=null,u=null,s=null,h=null,k=null,d=null,g=null,c=null,l=null,a=null,v={Booked:2,DeliveredFromProvider:64};return{editDelivery:ft,viewDelivery:rt,getTrackingEvents:ut,cancelDelivery:et,ConfirmCancelDilivery:ot,DismissCancelDilivery:st}}();